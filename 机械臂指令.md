# 机械臂串口通信协议

## 概述

### 通信协议结构

默认的上位机与下位机通信协议由下面几个部分组成：

**上位机向下位机发送数据包：**

| 帧头 | 帧长 | 包源 | 有效载荷 | 校验位 |
| ---- | ---- | ---- | -------- | ------ |

完整数据包：帧头 + 帧长 + 功能描述 + 有效载荷1 + 有效载荷2 + ······· + 有效载荷n + 校验位

上位机向下位机发送的数据包，帧头为 0xAA。

**下位机向上位机发送数据包：**

| 帧头 | 帧长 | 有效载荷 | 校验位 |
| ---- | ---- | -------- | ------ |

下位机向上位机发送的数据包，帧头为 0xCC。

### 协议概览

**上位机向下位机发送数据包：**

| 部分   | 值                     | 备注                                                         |
| ------ | ---------------------- | ------------------------------------------------------------ |
| 帧头   | 0xAA                   | FRAME_HEADER_SLAVE                                           |
| 帧长   | 4 + n                  | 整个数据帧的长度。4代表帧头+帧长+包源+校验位，n代表有效载荷个数。 |
| 包源   | 0x00                   | 执行动作组中的某一个动作。有效载荷包含所有舵机的角度、编号和执行当前动作所需时间。EXECUTE_ACTION |
| 包源   | 0x01                   | 将目标角度与当前角度不同的舵机转动到目标角度。有效载荷包含需要改变的舵机个数、角度和编号，执行当前动作所需时间。SERVO_ANGLE |
| 包源   | 0x02                   | 下载动作组中的某一个动作到Flash中。有效载荷包含所有舵机的角度和编号，执行当前动作所需时间。DOWNLOAD_ACTION_GROUP |
| 包源   | 0x03                   | 擦除某一以下载动作组。ERASE_ACTION_GROUP                     |
| 包源   | 0x04                   | 执行某一以下载的动作组。EXECUTE_DOWNLOADED_ACTION_GROUP      |
| 包源   | 0x05                   | 停止执行动作组。STOP_EXECUTING_ACTION_GROUP                  |
| 包源   | 0x06                   | 擦除全部以下载动作组。ERASE_ALL_ACTION_GROUP                 |
| 包源   | 0x07                   | 执行全部以下载动作组。EXECUTE_ALL_DOWNLOADED_ACTION_GROUP    |
| 校验位 | 校验位 = 校验和 & 0xFF | 校验和 = 帧头值+帧长值+包源值+有效载荷值；校验位的值为校验和的低八位。 |

**下位机向上位机发送数据包：**

| 部分     | 值                     | 备注                                                         |
| -------- | ---------------------- | ------------------------------------------------------------ |
| 帧头     | 0xCC                   | FRAME_HEADER_SLAVE                                           |
| 帧长     | 4                      |                                                              |
| 有效载荷 | 0x00                   | ACK                                                          |
|          | 0x01                   | ERROR                                                        |
|          | 0x02                   | FREE                                                         |
|          | 0x03                   | BUSY                                                         |
| 校验位   | 校验位 = 校验和 & 0xFF | 校验和 = 帧头值+帧长值+有效载荷值；校验位的值为校验和的低八位。 |

## 详述

### 在线执行动作组中的某一个动作

功能：在线执行动作组中的某一个动作。有效载荷包含所有舵机的角度、编号和执行当前动作所需时间。

Tips：如果需要在线执行某一动作组可以循环发送该指令

**上位机：**

| 部分     | 值                | 备注                                                         |
| -------- | ----------------- | ------------------------------------------------------------ |
| 帧头     | 0xAA              |                                                              |
| 帧长     | 4 + n = 24        | n = 2 + 6 * 3 = 20                                           |
| 包源     | 0x00              | EXECUTE_ACTION                                               |
| 有效载荷 | Time_H            | 执行当前动作所需时间，高八位                                 |
|          | Time_L            | 执行当前动作所需时间，低八位                                 |
|          | Servo${Number}    | 舵机编号                                                     |
|          | Angle_H_${Number} | 角度高八位                                                   |
|          | Angle_L_${Number} | 角度第八位                                                   |
|          | ...               | 一共6个舵机                                                  |
| 校验位   | 校验和 & 0xFF     | 校验和 = 帧头值+帧长值+有效载荷值；校验位的值为校验和的低八位。 |

**下位机：**

| 部分     | 值                     | 备注                                                         |
| -------- | ---------------------- | ------------------------------------------------------------ |
| 帧头     | 0xCC                   |                                                              |
| 帧长     | 4                      |                                                              |
| 有效载荷 | 0x02 / 0x03            | FREE / BUSY                                                  |
| 校验位   | 校验位 = 校验和 & 0xFF | 校验和 = 帧头值+帧长值+有效载荷值；校验位的值为校验和的低八位。 |

### 将目标角度与当前角度不同的舵机转动到目标角度

功能：将目标角度与当前角度不同的舵机转动到目标角度。有效载荷包含需要改变的舵机个数、角度和编号，执行当前动作所需时间。

**上位机：**

| 部分     | 值                | 备注                                                       |
| -------- | ----------------- | ---------------------------------------------------------- |
| 帧头     | 0xAA              |                                                            |
| 帧长     | 4+n               | n = 2 + 1 + NUMBER_OF_SERVOS* 2 = 3 +  NUMBER_OF_SERVOS* 2 |
| 包源     | 0x01              | SERVO_ANGLE                                                |
| 有效载荷 | Time_H            | 执行当前动作所需时间，高八位                               |
|          | Time_L            | 执行当前动作所需时间，低八位                               |
|          | NUMBER_OF_SERVOS  | 需要转动的舵机数量                                         |
|          | Servo_${Number}   | 舵机编号                                                   |
|          | Angle_H_${Number} | 角度高八位                                                 |
|          | Angle_L_${Number} | 角度第八位                                                 |
|          | ...               |                                                            |
| 校验位   | sum & 0xFF        |                                                            |

**下位机：**

| 部分     | 值                     | 备注                                                         |
| -------- | ---------------------- | ------------------------------------------------------------ |
| 帧头     | 0xCC                   |                                                              |
| 帧长     | 4                      |                                                              |
| 有效载荷 | 0x02 / 0x03            | FREE / BUSY                                                  |
| 校验位   | 校验位 = 校验和 & 0xFF | 校验和 = 帧头值+帧长值+有效载荷值；校验位的值为校验和的低八位。 |

### 下载动作组

功能：下载动作组中的某一个动作到Flash中。有效载荷包含所有舵机的角度和编号，执行当前动作所需时间。

Tips：下载一个完整的指令需要循环调用该指令，将所有的动作发送。每次下载命令发送后，下位机会应答一个ACK，来表示下载完毕。

**上位机：**

| 部分     | 值                  | 备注                         |
| -------- | ------------------- | ---------------------------- |
| 帧头     | 0xAA                |                              |
| 帧长     | 4 + n = 25          | n = 1 + 2 + 6 * 3 = 20       |
| 包源     | 0x02                | DOWNLOAD_ACTION_GROUP        |
| 有效载荷 | Action_Group_Number | 动作组编号                   |
|          | Time_H              | 执行当前动作所需时间，高八位 |
|          | Time_L              | 执行当前动作所需时间，低八位 |
|          | Servo_${Number}     | 舵机编号                     |
|          | Angle_H_${Number}   | 角度高八位                   |
|          | Angle_L_${Number}   | 角度第八位                   |
|          | ...                 | 一共6个舵机                  |
| 校验位   | sum & 0xFF          |                              |

**下位机：**

| 部分     | 值                     | 备注                                                         |
| -------- | ---------------------- | ------------------------------------------------------------ |
| 帧头     | 0xCC                   |                                                              |
| 帧长     | 4                      |                                                              |
| 有效载荷 | 0x00 / 0x01            | ACK / ERROR                                                  |
| 校验位   | 校验位 = 校验和 & 0xFF | 校验和 = 帧头值+帧长值+有效载荷值；校验位的值为校验和的低八位。 |

### 擦除某一动作组

 功能：擦除某一动作组。

**上位机：**

| 部分     | 值                  | 备注               |
| -------- | ------------------- | ------------------ |
| 帧头     | 0xAA                |                    |
| 帧长     | 5                   |                    |
| 包源     | 0x03                | ERASE_ACTION_GROUP |
| 有效载荷 | Action_Group_Number | 动作组编号         |
| 校验位   | sum & 0xFF          |                    |

**下位机：**

| 部分     | 值                     | 备注                                                         |
| -------- | ---------------------- | ------------------------------------------------------------ |
| 帧头     | 0xCC                   |                                                              |
| 帧长     | 4                      |                                                              |
| 有效载荷 | 0x00 / 0x01            | ACK / ERROR                                                  |
| 校验位   | 校验位 = 校验和 & 0xFF | 校验和 = 帧头值+帧长值+有效载荷值；校验位的值为校验和的低八位。 |

### 执行某一下载的动作组

功能：执行某一以下载的动作组。

**上位机：**

| 部分     | 值                  | 备注                            |
| -------- | ------------------- | ------------------------------- |
| 帧头     | 0xAA                |                                 |
| 帧长5    | 5                   |                                 |
| 包源     | 0x04                | EXECUTE_DOWNLOADED_ACTION_GROUP |
| 有效载荷 | Action_Group_Number | 动作组编号                      |
| 校验位   | sum & 0xFF          |                                 |

**下位机：**

| 部分     | 值                     | 备注                                                         |
| -------- | ---------------------- | ------------------------------------------------------------ |
| 帧头     | 0xCC                   |                                                              |
| 帧长     | 4                      |                                                              |
| 有效载荷 | 0x02 / 0x03            | FREE / BUSY                                                  |
| 校验位   | 校验位 = 校验和 & 0xFF | 校验和 = 帧头值+帧长值+有效载荷值；校验位的值为校验和的低八位。 |

### 停止执行动作组

功能：停止执行动作组。可以停止在线运行的动作组，和本地运行的动作组。

**上位机：**

| 部分     | 值         | 备注                        |
| -------- | ---------- | --------------------------- |
| 帧头     | 0xAA       |                             |
| 帧长5    | 5          |                             |
| 包源     | 0x05       | STOP_EXECUTING_ACTION_GROUP |
| 有效载荷 | 0x00       | 保留                        |
| 校验位   | sum & 0xFF |                             |

**下位机：**

| 部分     | 值                     | 备注                                                         |
| -------- | ---------------------- | ------------------------------------------------------------ |
| 帧头     | 0xCC                   |                                                              |
| 帧长     | 4                      |                                                              |
| 有效载荷 | 0x00 / 0x01            | ACK / ERROR                                                  |
| 校验位   | 校验位 = 校验和 & 0xFF | 校验和 = 帧头值+帧长值+有效载荷值；校验位的值为校验和的低八位。 |

### 擦除全部已下载动作组

功能：擦除全部以下载动作组

**上位机：**

| 部分     | 值         | 备注                   |
| -------- | ---------- | ---------------------- |
| 帧头     | 0xAA       |                        |
| 帧长     | 5          |                        |
| 包源     | 0x06       | ERASE_ALL_ACTION_GROUP |
| 有效载荷 | 0x00       | 保留                   |
| 校验位   | sum & 0xFF |                        |

**下位机：**

| 部分     | 值                     | 备注                                                         |
| -------- | ---------------------- | ------------------------------------------------------------ |
| 帧头     | 0xCC                   |                                                              |
| 帧长     | 4                      |                                                              |
| 有效载荷 | 0x00 / 0x01            | ACK / ERROR                                                  |
| 校验位   | 校验位 = 校验和 & 0xFF | 校验和 = 帧头值+帧长值+有效载荷值；校验位的值为校验和的低八位。 |

### 执行全部已下载动作组

功能：执行全部已下载动作组

**上位机：**

| 部分     | 值         | 备注                                |
| -------- | ---------- | ----------------------------------- |
| 帧头     | 0xAA       |                                     |
| 帧长5    | 5          |                                     |
| 包源     | 0x07       | EXECUTE_ALL_DOWNLOADED_ACTION_GROUP |
| 有效载荷 | 0x00       | 保留                                |
| 校验位   | sum & 0xFF |                                     |

**下位机：**

| 部分     | 值                     | 备注                                                         |
| -------- | ---------------------- | ------------------------------------------------------------ |
| 帧头     | 0xCC                   |                                                              |
| 帧长     | 4                      |                                                              |
| 有效载荷 | 0x02 / 0x03            | FREE / BUSY                                                  |
| 校验位   | 校验位 = 校验和 & 0xFF | 校验和 = 帧头值+帧长值+有效载荷值；校验位的值为校验和的低八位。 |
